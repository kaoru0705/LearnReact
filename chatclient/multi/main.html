<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>STOMP Room Chat (React CDN)</title>

  <!-- React CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SockJS + STOMP (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background:white; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.07); padding: 16px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .row > * { margin: 4px 0; }
    input, select { padding: 10px; border-radius: 10px; border: 1px solid #d9dbe3; outline: none; }
    button { padding: 10px 14px; border: none; border-radius: 10px; cursor:pointer; }
    button.primary { background:#2e6cff; color:white; }
    button.ghost { background:#eef1ff; }
    .status { font-size: 13px; color:#555; }
    .chatBox { height: 420px; overflow:auto; background:#0b1020; color:#e9ecff; border-radius: 14px; padding: 12px; }
    .msg { padding: 10px; border-radius: 12px; margin: 8px 0; background: rgba(255,255,255,0.06); }
    .meta { font-size: 12px; opacity: 0.85; margin-bottom: 4px; }
    .text { font-size: 14px; white-space: pre-wrap; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background: rgba(255,255,255,0.14); margin-left: 6px; font-size: 12px; }
  </style>
</head>
<body>
<div id="app"></div>

<script type="text/babel">
    
    function App(){
        // [ UIì™€ ìƒê´€ì—†ëŠ” ì»´í¬ë„ŒíŠ¸ì™€ ìƒëª…ì„ í•¨ê»˜í•˜ëŠ” ë³€ìˆ˜ ]
        const stompRef = React.useRef(null);    // STOMP ê°ì²´ë¥¼ ë‹´ì„ ë³€ìˆ˜
        const subscribeRef = React.useRef(null);    // êµ¬ë… ê°ì²´ë¥¼ ë‹´ì„ ë³€ìˆ˜
        const chatBoxRef = React.useRef(null);

        // [ UIì™€ ì—®ì¸ ë°”ì¸ë“œ ë³€ìˆ˜ ]
        const [status, setStatus] = React.useState("DISCONNECTED"); // í˜„ì¬ ì•±ì˜ ì ‘ì† ìƒíƒœë¥¼ ì¶œë ¥í•˜ê¸° ìœ„í•œ ìƒíƒœ ë³€ìˆ˜
        const [roomId, setRoomId] = React.useState("");  // ì‚¬ìš©ìì˜ ë£¸ë²ˆí˜¸ì™€ ì—®ì—¬ìˆê²Œ ë  ìƒíƒœë³€ìˆ˜
        const [name, setName] = React.useState("");  // ì‚¬ìš©ìì™€ ì—®ì—¬ìˆê²Œ ë  ìƒíƒœë³€ìˆ˜
        const [emoji, setEmoji] = React.useState("ğŸ™‚");  // ì´ëª¨ì§€ì™€ ì—®ì—¬ìˆê²Œ ë  ìƒíƒœë³€ìˆ˜
        const [message, setMessage] = React.useState("");  // ì „ì†¡ ë©”ì‹œì§€ì™€ ì—®ì—¬ìˆê²Œ ë  ìƒíƒœë³€ìˆ˜
        const [messages, setMessages] = React.useState([ ]); // ë©”ì‹œì§€ ì¶œë ¥ì— ì‚¬ìš©ë  ë°°ì—´ ìƒíƒœë³€ìˆ˜


        /*-----------------------------------------------------------------------------
        ì»´í¬ë„ŒíŠ¸ê°€ í™”ë©´ì— ê·¸ë ¤ì§ˆ ë•Œ ì›¹ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        ì»´í¬ë„ŒíŠ¸ê°€ í™”ë©´ì— ê·¸ë ¤ì§ˆ ë•Œë§ˆë‹¤ í˜¸ì¶œë˜ëŠ” ë¶€ìˆ˜íš¨ê³¼(side effect)ë¥¼ ì§€ì›í•˜ëŠ” ë©”ì„œë“œì¸ useEffect() ì´ìš©í•˜ê¸°
        -----------------------------------------------------------------------------*/
        React.useEffect(() => {
            //  @GetMapping("/me") /api/auth/me in AuthController
            fetch("http://localhost:9992/api/auth/me", {
                method: "GET",
                credentials: "include"   // ì„¸ì…˜ ì¿ í‚¤ë¥¼ ì£¼ê³ ë°›ìœ¼ë ¤ë©´ ë°˜ë“œì‹œ ì´ ì˜µì…˜ì„ ì¶”ê°€, ëˆ„ë½ë˜ë©´? ë¸Œë¼ìš°ì €ê°€ ì¿ í‚¤ë¥¼ ì „ì†¡í•˜ì§€ ì•ŠìŒ ë¡œê·¸ì¸ í–ˆë‹¤ ìƒê°í•˜ì§€ ì•ŠìŒ
            })
            .then(res => {
                if(!res.ok) throw new Error("ì—ëŸ¬ë°œìƒ");
                return res.json();  // ì„±ê³µí•œ ê²½ìš°ì—” ì‘ë‹µì •ë³´ë¥¼ jsê°ì²´ ë¦¬í„°ëŸ´ë¡œ ë³€í™˜í•˜ì—¬ ì—¬ê¸°ì„œ ë°˜í™˜ë˜ëŠ” Promiseì˜ resolve() ì•ˆì— ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬
            })
            .then(data => {
                console.log("ì„œë²„ì˜ ì‘ë‹µ ì •ë³´ëŠ” ", data);   // {ok:true, name:"zino"}
                // í™”ë©´ ìš°ì¸¡ì˜ ì‚¬ìš©ìëª… Inputì— ì±„ì›Œ ë„£ê¸°
                setName(data.name);

            })
            .catch(err => console.log(err));
        }, []);


        /*-----------------------------------------------------------------------------
        ì±„íŒ… ì„œë²„ ì ‘ì†
        -----------------------------------------------------------------------------*/
        const connect = () => {

            // ì¤‘ë³µ ì ‘ì†í–‰ìœ„ì— ëŒ€í•œ ë°©ì–´
            if(stompRef.current && stompRef.current.connected) {    // ì´ë¯¸ ì ‘ì†ì´ ë˜ì–´ ìˆë‹¤ë©´...
                //console.log(stompRef.current.connected);
                return;
            }


            setStatus("CONNECTING...");

            // registry.addEndpoint("/ws/stomp") in WebSocketStompConfig
            const sock = new SockJS("http://localhost:9992/ws/stomp");  // ìŠ¤í”„ë§ë¶€íŠ¸ ì±„íŒ… ì„œë²„
            const stomp = Stomp.over(sock);   // STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì›¹ì†Œì¼“ ìœ„ì—ì„œ ì‹¤í–‰ë¨
                                // ì´ ì‹œì ë¶€í„°ëŠ” stompë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤
            
            /* 
                STOMPë¥¼ ì´ìš©í•œ ì„œë²„ ì ‘ì† ì‹œë„ (connect() ë©”ì„œë“œ ë§¤ê°œë³€ìˆ˜ 3ê°œ)
                ì¸ìˆ˜ 1 -
                ì¸ìˆ˜ 2 - ì„±ê³µí–ˆì„ ë•Œì˜ ì½œë°±í•¨ìˆ˜
                ì¸ìˆ˜ 3 - ì‹¤íŒ¨í–ˆì„ ë•Œì˜ ì½œë°±í•¨ìˆ˜
            */
            stomp.connect({}, () => {
                setStatus("CONNECTED"); // ìƒíƒœ í‘œì‹œ ì˜ì—­ì— ì„±ê³µ ì¶œë ¥
                stompRef.current = stomp;   // ì „ì—­ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ê³ , ì»´í¬ë„ŒíŠ¸ refë³€ìˆ˜ì— ë‹´ì
            },
            () => {
                console.log(err);
                setStatus("ERROR");
            });
        }
        /*-----------------------------------------------------------------------------
        ë°© ì…ì¥ (êµ¬ë… ì‹ ì²­)

        [ subscribe() ë©”ì„œë“œ ]
        ì¸ìˆ˜ 1 - êµ¬ë… ì£¼ì†Œ ì˜ˆ) /topic/room/roomë²ˆí˜¸
                ì°¸ê³  1) êµ¬ë… ì£¼ì†Œë¥¼ destinationì´ë¼ í•¨
                ì°¸ê³  2) êµ¬ë… ì‹ ì²­ ì‹œ êµ¬ë… ì£¼ì†Œë§Œ ì „ì†¡ë˜ëŠ” ê²Œ ì•„ë‹ˆë¼, êµ¬ë… êµ¬ë¶„ idë„ í•¨ê»˜ ì „ì†¡ë¨ ex) sub-0  accessor.getSubscriptionId(); in StompEventListener

        ì¸ìˆ˜ 2 - êµ¬ë… ìš”ì²­ ì‹œ ì‚¬ìš©ë˜ëŠ” ê°’ì´ ì•„ë‹ˆë¼, êµ¬ë… ì‹ ì²­ í›„ ì„œë²„ì—ì„œ ì „ì†¡ëœ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•  ì½œë°±í•¨ìˆ˜
                ë”°ë¼ì„œ, ê°™ì€ ë°©ì— ìˆëŠ” ì‚¬ìš©ìë“¤ì˜ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹œë¡œ ë°›ëŠ” í•¨ìˆ˜...
        -----------------------------------------------------------------------------*/

        const joinRoom = () => {

            // ì ‘ì†í•˜ì§€ ì•Šê³  êµ¬ë…(ë°©ì— ì°¸ì—¬)ì„ ì‹œë„í•  ê²½ìš°
            if(!stompRef.current || !stompRef.current.connected) {
                alert("ë¨¼ì € ì ‘ì† í›„ ë£¸ì„ ë“±ë¡í•˜ì„¸ìš”");
                return;
            }

            // ë£¸ ë²ˆí˜¸ì— ëŒ€í•œ ìœ íš¨ì„± ì²´í¬ ( ì…ë ¥ ì•ˆ í•  ê²½ìš° ë°©ì–´)
            const rid = roomId.trim();  // í˜¹ì‹œë¼ë„ ëª¨ë¥¼ ê³µë°±ì„ ì œê±°í•˜ê³  ìˆœìˆ˜í•œ ë¬¸ìì—´ ë‚¨ê¹€ ex) "5  " -> "5"
            if(!rid) {
                alert("roomIDë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                return;
            }

            // ì´ë¯¸ êµ¬ë…ëœ ì •ë³´ê°€ ìˆë‹¤ë©´, ì¤‘ë³µë  ê²½ìš° ê¼¬ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ êµ¬ë… ë“±ë¡ ì „ ì´ì „ ë“±ë¡ì„ í•´ì œ
            if(subscribeRef.current) {
                subscribeRef.current.unsubscribe();
                subscribeRef.current = null;
            }


            // ì¶”í›„ ë‹¤ë¥¸ ë©”ì„œë“œ ë“±ì—ì„œ êµ¬ë… ê°ì²´ë¥¼ ì ‘ê·¼í•˜ê²Œ í•˜ê¸° ìœ„í•´ subscribeRefë¡œ ë‹´ì•„ ë‘ 
            subscribeRef.current = stompRef.current.subscribe(`/topic/room/${rid}`, (frame) => {
                // ì„œë²„ì—ì„œ ì „ì†¡ëœ ë©”ì‹œì§€ê°€ frameìœ¼ë¡œ ë“¤ì–´ì˜´
                //console.log("frame is ", frame);

                // ì‹¤ì œì ì¸ ë©”ì‹œì§€ ë‚´ìš©ì€ bodyì— json ë¬¸ìì—´ë¡œ ë“¤ì–´ìˆìœ¼ë¯€ë¡œ (ìŠ¤í”„ë§ì—ì„œ @ResponseBodyë¡œ í–ˆê¸° ë•Œë¬¸...),
                // ì‚¬ìš© ì „ì— js ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•˜ì. json ë¬¸ìì—´ -> js ê°ì²´ë¡œ ë³€í™˜í•˜ë ¤ë©´ parse()í•´ì•¼ í•¨
                const body = JSON.parse(frame.body);
                console.log("ì„œë²„ì—ì„œ ì˜¨ ë©”ì‹œì§€ ë‚´ìš©ì€ ", body);

                // ê¸°ì¡´ messages ë°°ì—´ì— bodyë¥¼ ì¶”ê°€í•œ ìƒˆë¡œìš´ ë°°ì—´ì„ ë°˜í™˜í•˜ì—¬ ì‚¬ìš©
                setMessages(prev => [...prev, body]);   // prevëŠ” ê¸°ì¡´ messages ë°°ì—´
            });
        }

        /*-----------------------------------------------------------------------------
        ë©”ì‹œì§€ ì „ì†¡
        -----------------------------------------------------------------------------*/

        // messages ë³€ê²½ë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì²˜ë¦¬
        React.useEffect(() => {
            if(!chatBoxRef.current) return;
            chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
        }, [messages]);

        const send = () => {
            // ì—°ê²° ì—¬ë¶€ í™•ì¸
            if(!stompRef.current || !stompRef.current.connected) {
                alert("ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ë ¤ë©´, ë¨¼ì € ì ‘ì†ì„ í•´ì£¼ì„¸ìš”");
                return;
            }

            // ë©”ì‹œì§€ ì—†ìœ¼ë©´, ì½”ë“œ ì‹¤í–‰ ì•ˆ í•¨
            if(!message) {
                return;
            }


            // ì„œë²„ê°€ ChatMessage ê°ì²´ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ë°›ê³  ìˆìœ¼ë¯€ë¡œ, json í˜•íƒœë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì „ì†¡í•˜ì
            const payload = {
                name: name,
                emoji: emoji,
                message: message
            }

            //console.log("payload", payload);

            stompRef.current.send(`/app/room/${roomId}/send`, {}, JSON.stringify(payload));

            setMessage(""); // ì…ë ¥ ì´ˆê¸°í™”
        }



        /*-----------------------------------------------------------------------------
        ì ‘ì† í•´ì œ
        -----------------------------------------------------------------------------*/

        const disconnect = () => {

            try {
                // ê¸°ì¡´ì˜ êµ¬ë… ì‹ ì²­ì´ ìˆë‹¤ë©´, êµ¬ë… í•´ì œ
                // ì•ˆ ê·¸ëŸ¬ë©´ topic/room/4 sub-01 sub-01 sub-01 sub-01
                if(subscribeRef.current && stompRef.current) {
                    subscribeRef.current.unsubscribe();
                    subscribeRef.current = null;
                }

                if(stompRef.current) {
                    stompRef.current.disconnect(() => {});  // ì ‘ì† í•´ì œ
                    stompRef.current = null;    // ì ‘ì† í•´ì œì™€ ë™ì‹œì— ê°ì²´ ë‹¤ì‹œ ì´ˆê¸°í™”
                    
                }
            }finally {
                /*
                    disconnect() í˜¸ì¶œì— ì˜í•œ í•´ì œ ì‹¤íŒ¨ë€? ì‚¬ì‹¤ ìƒ, ë³´í†µ ì•„ë˜ì™€ ê°™ì€ ê²½ìš°ê°€ ëŒ€ë¶€ë¶„ì´ë‹¤.
                    1) ì´ë¯¸ ì„œë²„ê°€ ë¨¼ì € ì—°ê²°ì„ ëŠì€ ê²½ìš°(ì„œë²„ì˜ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬, ì„œë²„ ì¢…ë£Œ)
                    2) ì†Œì¼“ì´ half-open ìƒíƒœ
                        í•œìª½ ë(í´ë¼ì´ì–¸íŠ¸ í˜¹ì€ ì„œë²„)ì€ ì—°ê²°ì´ ëŠê²¼ë‹¤ê³  í™•ì‹ í•˜ëŠ”ë°, ë°˜ëŒ€ìª½ì€ ì—¬ì „íˆ ì—°ê²°ë˜ì–´ ìˆë‹¤ê³  ë¯¿ê³  ìˆëŠ” ì¢€ë¹„ ìƒíƒœ

                    ì¦‰, ìœ ì €ê°€ ì ‘ì†í•´ì œë¥¼ ì‹œë„í•˜ë©´ ì–´ë– í•œ ì´ìœ ì—ì„œê±´ ì ‘ì†ì€ ìœ ì§€ë  ìˆ˜ ì—†ë‹¤.
                    ë”°ë¼ì„œ finallyì— setStatus("DISCONNECTED");
                */
                setStatus("DISCONNECTED");
            }
        }


        return (

            <div className="wrap">
                <div className="card">
                    <h2 style={{ margin: "0 0 10px 0" }}>Step2+3 - STOMP ì±„íŒ…ë°©(Room) (No Auth)</h2>

                    <div className="row">
                    <div className="status">
                        <b>Status:</b> <span id="status">{status}</span>
                        <span id="room-pill" className="pill" style={{ display: "none" }}>Room </span>
                    </div>

                    <div style={{ flex: 1 }}></div>

                    <button className="ghost" id="btn-connect" onClick={connect}>Connect</button>
                    <button className="ghost" id="btn-disconnect" onClick={disconnect}>Disconnect</button>
                    </div>

                    <hr style={{ border: 0, borderTop: "1px solid #eee", margin: "14px 0" }} />

                    <div className="row">
                    <input
                        id="input-roomId"
                        type="text"
                        placeholder="roomId (ì˜ˆ: 1,2,study)"
                        value={roomId}
                        onChange={e => setRoomId(e.target.value)}
                    />
                    <button className="primary" id="btn-join" onClick={joinRoom}>Join Room</button>

                    <div style={{ flex: 1 }}></div>

                    <input
                        id="input-nickname"
                        type="text"
                        placeholder="ë‹‰ë„¤ì„"
                        value={name}
                    />
                    <select id="select-emoji" value={emoji} onChange={e => setEmoji(e.target.value)}>
                        <option value="ğŸ™‚">ğŸ™‚</option>
                        <option value="ğŸ˜„">ğŸ˜„</option>
                        <option value="ğŸ˜">ğŸ˜</option>
                        <option value="ğŸ”¥">ğŸ”¥</option>
                        <option value="ğŸ‰">ğŸ‰</option>
                        <option value="âœ…">âœ…</option>
                        <option value="âš ï¸">âš ï¸</option>
                        <option value="â¤ï¸">â¤ï¸</option>
                    </select>
                    </div>
                    {/* ref={} ì´ DOM ìš”ì†Œê°€ ì‹¤ì œë¡œ ë§Œë“¤ì–´ì§€ë©´ ê·¸ DOM ê°ì²´ë¥¼ chatBoxRef.currentì— ë„£ì–´ì¤˜ */}
                    <div style={{ marginTop: "14px" }} className="chatBox" id="chat-box" ref={chatBoxRef}>
                        {
                            messages.length === 0 ?
                            (<div id="empty-message" style={{ opacity: 0.75 }}>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. Join Room í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.</div>) :
                            (
                                messages.map((obj, idx) => {
                                    return (
                                        <div className="msg" key={idx}>
                                            <div className="meta">
                                                <b>{obj.emoji} {obj.name}</b>
                                                <span style={{ marginLeft: 8 }}>
                                                    {obj.time}
                                                </span>
                                            </div>
                                            <div className="text">{obj.message}</div>
                                        </div>
                                    )
                                })
                            )
                        }
                    </div>

                    <div className="row" style={{ marginTop: "12px" }}>
                    <input
                        id="input-message"
                        style={{ flex: 1, minWidth: "260px" }}
                        type="text"
                        placeholder="ë©”ì‹œì§€ ì…ë ¥"
                        value={message}
                        onChange={e => setMessage(e.target.value)}
                        onKeyUp={e => {
                            if(e.key === "Enter") send();
                        }}
                    />
                    <button className="primary" id="btn-send" onClick={send}>Send</button>
                    </div>

                    <div style={{ marginTop: "10px", fontSize: "12px", color: "#666" }}>
                    WS ì ‘ì†: <code>/ws/stomp</code> / êµ¬ë…: <code>/topic/room/23</code> / ì „ì†¡: <code>/app/room/23"/send</code>
                    </div>
                </div>
            </div>
        )
    }    
    
    ReactDOM.createRoot(document.getElementById("app")).render(<App />);

</script>    
</body>
</html>
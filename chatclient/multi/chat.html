<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>STOMP Room Chat (React CDN)</title>

    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SockJS + STOMP (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; }
        .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
        .card { background:white; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.07); padding: 16px; }
        .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
        .row > * { margin: 4px 0; }
        input, select { padding: 10px; border-radius: 10px; border: 1px solid #d9dbe3; outline: none; }
        button { padding: 10px 14px; border: none; border-radius: 10px; cursor:pointer; }
        button.primary { background:#2e6cff; color:white; }
        button.ghost { background:#eef1ff; }
        .status { font-size: 13px; color:#555; }
        .chatBox { height: 420px; overflow:auto; background:#0b1020; color:#e9ecff; border-radius: 14px; padding: 12px; }
        .msg { padding: 10px; border-radius: 12px; margin: 8px 0; background: rgba(255,255,255,0.06); }
        .meta { font-size: 12px; opacity: 0.85; margin-bottom: 4px; }
        .text { font-size: 14px; white-space: pre-wrap; }
        .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background: rgba(255,255,255,0.14); margin-left: 6px; font-size: 12px; }
    </style>
</head>
<body>
<div id="app"></div>

<script type="text/babel">


function App() {
    /*-----------------------------
    ë°”ì¸ë“œ ë³€ìˆ˜(ì»´í¬ë„ŒíŠ¸ì™€ í•¨ê»˜ ì‚´ì•„ê°€ë©´ì„œ, íŠ¹íˆ UIì™€ í›„í‚¹ë˜ì–´ ìˆëŠ” ìƒíƒœ ë³€ìˆ˜)
    ------------------------------*/
    const [name, setName] = React.useState("");
    const [roomId, setRoomId] = React.useState("");

    /*-----------------------------
    Ref ë³€ìˆ˜(ì»´í¬ë„ŒíŠ¸ì™€ í•¨ê»˜ ì‚´ì•„ê°€ë©´ì„œ, íŠ¹íˆ UI ìƒê´€ì—†ëŠ” ë³€ìˆ˜)
    ------------------------------*/
    const stompRef = React.useRef(null);

    /*-----------------------------
    ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ ì§í›„ì— ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    ------------------------------*/
    React.useEffect(() => {
        fetch("http://localhost:9992/api/auth/me", {
            method: "GET",
            credentials: "include"  // ì„¸ì…˜ê³¼ ì¿ í‚¤ êµ¬í˜„ ì‹œ í•„ìš”, ì´ ì˜µì…˜ì´ ìˆì–´ì•¼ ë¸Œë¼ìš°ì €ê°€ ì¿ í‚¤ë¥¼ ì„œë²„ì— ì „ì†¡
        })
        .then(res => res.json())
        .then(data => {
            // ìš°ì¸¡ ìƒë‹¨ ì˜ì—­ì— ì±„íŒ…ì„ ì§„í–‰í•  ì‚¬ëŒì˜ ì´ë¦„ì„ ìë™ ì¶œë ¥
            setName(data.name);
            
        })
        .catch(err => console.log("ì¡°íšŒ ì‹¤íŒ¨"));

    }, []);

    /*-----------------------------
    ì±„íŒ… ì„œë²„ ì ‘ì†
    ------------------------------*/
    const connect = () => {
        //alert("ì ‘ì†í•  ê±°ì•¼");

        // WebSocketì€ í‘œì¤€ì´ê¸°ëŠ” í•˜ë‚˜, í™˜ê²½ì— ë”°ë¼ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆê¸°ì—, ë¯¸ë¦¬ Sockjsë¥¼ ì‚¬ìš©í•´ë³´ì
        // íš¨ê³¼ ë™ì¼
        const sock = new SockJS("http://localhost:9992/ws/stomp");

        const stomp = Stomp.over(sock);   // StompëŠ” ë©€í‹° ìºìŠ¤íŒ… ì±„íŒ…ì„ êµ¬ë… ê°œë…ìœ¼ë¡œ ë‹¨ìˆœí™” ì‹œì¼œì„œ, ë³´ë‹¤ ì‰½ê²Œ ë©”ì‹œì§€ í†µì‹ ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŒ
                                        // StompëŠ” WebSocket, Sock.js ê¸°ë°˜ ìœ„ì—ì„œ ì‹¤í–‰ë¨

        stomp.connect({}, () => {
            console.log("ì ‘ì† ì„±ê³µ");
            stompRef.current = stomp;   // Ref ê°ì²´ì— ë¬´ì–¸ê°€ ë‹´ì„ ë•ŒëŠ” ê°ì²´ ìì²´ì— ë‹´ëŠ” ê²Œ ì•„ë‹ˆë¼, Refê°€ ê°€ì§„ current propertyì— ë‹´ì•„ì•¼ í•¨
        }, (err) => {
            console.log("Stomp connect error", err);
        });
    }

    /*-----------------------------
    ë°©ì— ì…ì¥
    ------------------------------*/
    const joinRoom = () => {
        // ì ‘ì†ë„ í•˜ì§€ ì•Šìœ¼ë©´ì„œ ë°© ë“¤ì–´ê°€ê¸°ë¥¼ ë¨¼ì € ëˆ„ë¥¸ ê²½ìš° ìš•í•˜ì!
        if(!stompRef.current || !stompRef.current.connected){
            alert("ë¨¼ì € ì ‘ì†ì„ í•´ì£¼ì„¸ìš”");
            return;
        }

        const rid = roomId.trim();  // í˜¹ì‹œë¼ë„ ëª¨ë¥¼, ê³µë°±ë¬¸ì ì œê±° ì˜ˆ) "5ê³µë°±" --> "5"
        if(!rid){
            alert("ë£¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            return;
        }

        // ì´ì „ì— êµ¬ë…í•´ë†“ì€ ê²Œ ìˆë‹¤ë©´ êµ¬ë… í•´ì œ...
        
        // ì±„íŒ… ë©”ì‹œì§€ ì´ˆê¸°í™”

        // ë£¸ ì°¸ì—¬ì˜ ì˜ë¯¸ëŠ” Stomp Chatting serverì—ê²Œ ì´ ë°©ì„ êµ¬ë…í•˜ê² ë‹¤ëŠ” ì˜ë¯¸
        stompRef.subscribe(`/topic/room/${rid}`, (frame) => {
            // ë°ì´í„° ì „ì†¡ì„ ìœ„í•´ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
            const body = JSON.parse(frame.body);

        })

    }

    const send = () => {

        stompRef.current.send("/app/room/" + roomId + "/send", {}, "aaaaaa");    // ìŠ¤í”„ë§ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ìš”ì²­ì„ ë°›ê¸° ë•Œë¬¸ì— uri ìƒì„±
    }


    /*-----------------------------
    ì±„íŒ… ì„œë²„ ì ‘ì† í•´ì œ
    ------------------------------*/

    const disconnect = () => {
        // ì ‘ì†í•´ì œë¥¼ í•˜ê²Œ ë˜ë©´ êµ¬ë… ì·¨ì†Œ...

        // ì¡´ì¬í•  ë•Œë§Œ í•´ì œ
        if(stompRef.current) {
            stompRef.current.disconnect(() => {
    
            });
            stompRef.current = null;    // í•´ì œ í›„ ë³€ìˆ˜ê°’ ë‹¤ì‹œ ì´ˆê¸°í™”
        }
    }


    return (
    <div className="wrap">
        <div className="card">
        <h2 style={{ margin: "0 0 10px 0" }}>Step2+3 - STOMP ì±„íŒ…ë°©(Room) (No Auth)</h2>

        <div className="row">
            <div className="status">
            <b>Status:</b> {status}
            <span className="pill">Room </span>
            </div>

            <div style={{ flex: 1 }} />

            <button className="ghost" onClick={connect}>Connect</button>
            <button className="ghost" >Disconnect</button>
        </div>

        <hr style={{ border: 0, borderTop: "1px solid #eee", margin: "14px 0" }} />

        <div className="row">
            <input value={roomId} placeholder="roomId (ì˜ˆ: 1,2,study)" onChange={e => setRoomId(e.target.value)} />
            <button className="primary" onClick={joinRoom}>Join Room</button>

            <div style={{ flex: 1 }} />

            <input value={name} placeholder="ë‹‰ë„¤ì„"/>
            <select>
            <option value="ğŸ™‚">ğŸ™‚</option>
            <option value="ğŸ˜„">ğŸ˜„</option>
            <option value="ğŸ˜">ğŸ˜</option>
            <option value="ğŸ”¥">ğŸ”¥</option>
            <option value="ğŸ‰">ğŸ‰</option>
            <option value="âœ…">âœ…</option>
            <option value="âš ï¸">âš ï¸</option>
            <option value="â¤ï¸">â¤ï¸</option>
            </select>
        </div>

        <div style={{ marginTop: 14 }} className="chatBox">
            
            <div style={{ opacity: 0.75 }}>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. Join Room í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.</div>
            
            
                <div className="msg">
                <div className="meta">
                    <b></b>
                    <span style={{ marginLeft: 8 }}>
                    </span>
                </div>
                <div className="text">ë©”ì‹œì§€</div>
            </div>
        </div>

        <div className="row" style={{ marginTop: 12 }}>
            <input
            style={{ flex: 1, minWidth: 260 }}
            placeholder="ë©”ì‹œì§€ ì…ë ¥"/>

            <button className="primary" onClick={send}>Send</button>
        </div>

        <div style={{ marginTop: 10, fontSize: 12, color: "#666" }}>
            
        </div>
        </div>
    </div>
    );
    }
    ReactDOM.createRoot(document.getElementById("app")).render(<App />);
</script>
</body>
</html>
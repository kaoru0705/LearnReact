<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
    
    <!-- ë¦¬ì•¡íŠ¸ í”„ë¡œê·¸ë¨ì´ ë Œë”ë§ ë  ì˜ì—­ -->
    <div id="app"></div>




    <!-- text/babelì„ ëª…ì‹œí•´ì•¼ í•¨ìˆ˜ ì•ˆ íƒœê·¸ì— ëŒ€í•´ ë‹¹í™©í•˜ì§€ ì•ŠëŠ”ë‹¤. -->
    <script type="text/babel">

        // ë¶€ëª¨ì¸ ë£¨íŠ¸ ì»´í¬ë„ŒíŠ¸ ì •ì˜
        function App(){
            const [status, setStatus] = React.useState("DISCONNECTED");
            const [user, setUser] = React.useState("");     
            const [input, setInput] = React.useState("");   // ì…ë ¥ í…ŒìŠ¤íŠ¸ë°•ìŠ¤ì— ë“¤ì–´ê°ˆ ë°”ì¸ë“œ ë³€ìˆ˜
            const [icon, setIcon] = React.useState("");
            const [msgList, setMsgList] = React.useState([]);     // ë°”ì¸ë”© ë³€ìˆ˜ë¡œ ì„ ì–¸í•œ ì´ìœ , UIì— ë°˜ì˜ë˜ì–´ì•¼ í•˜ë¯€ë¡œ



            // ì»´í¬ë„ŒíŠ¸ ë‚´ì—ì„œ ë°”ì¸ë”© ëª©ì ì´ ì•„ë‹Œ, ì¦‰ ë Œë”ë§ê³¼ ë¬´ê´€í•˜ì§€ë§Œ ì»´í¬ë„ŒíŠ¸ì˜ ìƒëª…ì£¼ê¸° ë™ì•ˆ ìœ ì§€ë˜ì–´ì•¼ í•˜ëŠ”
            // ê°’ì€(ì €ì¥ê³µê°„) useRefë¥¼ ì´ìš©í•œë‹¤. ì „ì—­ë³€ìˆ˜ì²˜ëŸ¼ wsë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.
            const wsRef = React.useRef(null);     //wsRefëŠ” ì´ ì‹œì ë¶€í„° ref ê°ì²´ê°€ ë˜ë©°, ì‹¤ì œ ë°ì´í„°ëŠ” ref ì•ˆì— current Propertyì— ë‹´ì•„ì•¼ í•œë‹¤.

            function connect(){
                // í˜„ì¬ stateê°€ ì¡´ì¬í•˜ë©´ readyStateëŠ” ìë™ìœ¼ë¡œ OPENì´ ë“¤ì–´ê°€ ìˆë‹¤.
                if(wsRef.current && wsRef.current.readyState === WebSocket.OPEN){   // ì´ë¯¸ ì ‘ì†ì´ ë˜ì–´ ìˆë‹¤ë©´, ë” ì´ìƒ ì½”ë“œ ì§„í–‰ì„ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ì§€ ëª»í•˜ê²Œ ë°©ì–´
                    return;
                }

                // 2011ë…„ë„ì— í‘œì¤€í™”ë˜ì—ˆê¸° ë•Œë¬¸ì— í‘œì¤€ì„ ì¤€ìˆ˜í•˜ëŠ” ëª¨ë“  ë¸Œë¼ìš°ì €ëŠ” ì›¹ì†Œì¼“ì„ ë³´ìœ í•˜ê³  ìˆë‹¤
                // ìš°ë¦¬ê°€ ì›¹ ì„œí•‘ì„ í•  ë•ŒëŠ” ì£¼ì†Œì°½ì— http://ë‚˜ https://ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” **"ë¬¸ì„œ(HTML)ë¥¼ ì£¼ê³ ë°›ì"**ëŠ” ì•½ì†ì…ë‹ˆë‹¤.
                // ë°˜ë©´, ws://ëŠ” **"ì‹¤ì‹œê°„ìœ¼ë¡œ ì–‘ë°©í–¥ í†µì‹ ì„ í•˜ì"**ëŠ” ì „í˜€ ë‹¤ë¥¸ ì•½ì†ì…ë‹ˆë‹¤.
                //new WebSocket("ws://ìŠ¤í”„ë§ì„œë²„ì£¼ì†Œ");
                const ws = new WebSocket("ws://localhost:9991/ws/echo");
                wsRef.current = ws;

                setStatus("CONNECTING");
                
                // WebSocketì€ í†µì‹ ì— í•„ìš”í•œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì§€ì›
                ws.onopen = () => {

                    // ì´ ë¼ì¸ì„ ë§Œë‚œë‹¤ëŠ” ê²ƒì€ ì—ëŸ¬ ì—†ì´ ì ‘ì†ì— ì„±ê³µí–ˆë‹¤ëŠ” ê²ƒì´ë¯€ë¡œ, ë°”ì¸ë”© ë³€ìˆ˜ì¸ status ê°’ì„ ì ‘ì† ìƒíƒœë¡œ ì „í™˜
                    // ì ‘ì†ì´ ì„±ê³µë˜ì—ˆì„ ë•Œ ê°ì§€í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì´ìš©í•œ ì ‘ì† ì„±ê³µ ì²˜ë¦¬
                    setStatus("CONNECTED");
                }
                ws.onclose = () => {
                    // ì ‘ì†ì´ í•´ì œë˜ì—ˆì„ ë•Œë¥¼ ê°ì§€í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬...
                    setStatus("DISCONNECTED");
                }
                ws.onerror = () => {
                    setStatus("ERROR");
                }

                ws.onmessage = (event) => {
                    console.log("ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ë„ì°© ", event.data);
                    setMsgList(prev => [...prev, event.data]);
                }

            }

            // function disconnectì²˜ëŸ¼ ì ì–´ë„ ë˜ì§€ë§Œ ì´ë ‡ê²Œë„ ê°€ëŠ¥
            const sendMessage = () => {
                // ì ‘ì†ì´ ê³„ì† ìœ ì§€ë˜ì–´ ìˆë‹¤ë©´, ê·¸ë•Œë§Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ì
                if(!wsRef.current && wsRef.current.readyState !== WebSocket.OPEN){
                    return;

                }
                
                // ë©”ì‹œì§€ ë³´ë‚¼ ì˜ˆì •
                // ë³´ë‚¸ì‚¬ëŒ, ë³´ë‚¼ë©”ì‹œì§€, ì´ëª¨í‹°ì½˜
                /*
                    {
                        "id": "zino",
                        "msg": "ë°°ê³ íŒŒ",
                        "icon": "smile"
                    }
                */

                let payload = {
                    id : user,
                    message : input,
                    icon : icon
                }

                let data = JSON.stringify(payload);
                wsRef.current.send(data);

                setInput("");
            }

            function disconnect(){
                wsRef.current.close();  // ì ‘ì† ëŠê¸°
            }

            return (
                <div id="wrapper">
                    <h2>WebSocket Echo Client</h2>

                    <div>
                        <b>Status: {status}</b>
                    </div>

                    <div>
                        <button onClick={connect}>Connect</button>
                        <button onClick={disconnect}>Disconnect</button>
                    </div>

                    <div>
                        <div>
                            <input type="text" value={user} placeholder="ì‚¬ìš©ìëª… ì…ë ¥" onChange={e => setUser(e.target.value)}/>
                        </div>

                        <div>
                            <input type="text" value={input} placeholder="message input" onChange={e => setInput(e.target.value)}/>
                        </div>

                        <div>
                            <select value={icon} onChange={e => setIcon(e.target.value)}>
                                <option value="smile">ğŸ˜Š</option>
                                <option value="cry">ğŸ˜¢</option>
                                <option value="jump">ğŸ¤£</option>
                                <option value="angry">ğŸ˜¡</option>
                            </select>
                        </div>

                        <div>
                            <button onClick={sendMessage}>Send</button>
                        </div>
                    </div>

                    <div>
                        <h4>Received Message</h4>
                        <ul>
                            {msgList.map((msg, idx) => (<li key={idx}>{msg}</li>))}
                        </ul>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById("app"));
        root.render(<App />);
    </script>

</body>
</html>